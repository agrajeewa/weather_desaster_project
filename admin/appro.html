<?php
// Database connection
$conn = new mysqli("localhost", "root", "", "dms");

if ($conn->connect_error) {
    die("Connection failed: " . $conn->connect_error);
}

// Fetch only pending disasters
$sql = "SELECT user, disaster, location, status FROM desaster";
$result = $conn->query($sql);
?>

<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" href="style.css">
    <title>Approval Queue</title>
    <script>
        function updateStatus(btn, userName, action) {
            let cell = btn.parentElement; 
            
            // Send data to PHP via Fetch
            fetch('process_action.php', {
                method: 'POST',
                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                body: `user=${userName}&status=${action}`
            })
            .then(response => response.text())
            .then(data => {
                // Update the UI only for this specific row
                if(action === 'Approved') {
                    cell.innerHTML = "Approved";
                    cell.style.backgroundColor = "#0df305a9";
                } else {
                    cell.innerHTML = "Rejected";
                    cell.style.backgroundColor = "#f30505a9";
                }
                cell.style.color = "white";
                console.log(data);
            });
        }
    </script>
</head>
<body>
    <nav>
        <a href="admin.html">Home</a>
        <a href="appro.php" class="active">Approvel Queue</a>
        <a href="vict.html" >Victem Monitor</a>
        <a href="user.php">Users</a>
        <a href="../login/login.html">Logout</a>
    </nav>

    <div class="container">
        <h2 style="display: no;">Pending Disaster Warnings</h2>
        <table>
            <tr>
                <th>User</th>
                <th>Disaster Type</th>
                <th>Location</th>
                <th>Actions</th>
            </tr>
            <?php
            if ($result->num_rows > 0) {
                while($row = $result->fetch_assoc()) {
                    echo "<tr>";
                    echo "<td>" . $row["user"] . "</td>";
                    echo "<td>" . $row["disaster"] . "</td>";
                    echo "<td>" . $row["location"] . "</td>";
                    echo "<td>";
                    // If already processed, show status, else show buttons
                    if ($row["status"] == "pending") {
                        echo "<button class='btn btn-approve' onclick=\"updateStatus(this, '" . $row['user'] . "', 'Approved')\ ">Approve</button> ";
                        update desaster set status='Approved' where user='$user';
                        echo "<button class='btn btn-reject' onclick=\"updateStatus(this, '" . $row['user'] . "', 'Rejected')\">Reject</button>";
                        update desaster set status='Rejected' where user='$user';
                    } else {
                        echo ucfirst($row["status"]);
                    }
                    echo "</td>";
                    echo "</tr>";
                }
            } else {
                echo "<tr><td colspan='4'>No pending reports</td></tr>";
            }
            ?>
        </table>
    </div>
</body>
</html>